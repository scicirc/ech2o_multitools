#!/usr/bin/env python
# -*- coding: utf-8 -*-
'''

Python scripts for ECH2O

-------
Routine: Subroutines objective functions
-------
Author: S. Kuppel
Created on 05/2020
-------------------------------------------------
'''

from __future__ import division
from scipy.special import gamma
import numpy as np
import pandas as pd
import math

# ==============================================================================
# -- global likelihood from Schoups & Vrught, 2010


def Multi_NSE(obs, sim, Data, Opti):

    like = 0
    for i in range(Data.nobs):
        oname = Data.names[i]
        print(oname)
        # Have obervation and simulations matching the same time period
        # obs: are already pre-processed
        tobs = obs[oname]['Date'].values
        obs = np.asanyarray(obs[oname]['value'].values)
        # sim: trim sim to obs timespan
        # + only keep dates with obs (even if nan)
        mod = np.asanyarray(sim[i, :] for i in range(Data.lsimEff) if
                            Data.simt[i] in pd.to_datetime(tobs))
        print(mod.shape)
        print(obs.shape)
        # Remove nan
        tmp = mod*obs
        mod = np.asanyarray([mod[i] for i in range(len(mod)) if
                             np.isnan(tmp[i]) is False])
        obs = np.asanyarray([obs[i] for i in range(len(obs)) if
                             np.isnan(tmp[i]) is False])

        # Mean values
        mean_obs = np.mean(obs) #, axis=axis)

        n = ((obs - mod) ** 2).sum() #axis=axis)
        d = ((obs - mean_obs) ** 2).sum() #axis=axis)

        like += 1 - (n / d)

    return like
